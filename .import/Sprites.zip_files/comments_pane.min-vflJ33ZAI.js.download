define(["require","exports","tslib","react","external/react-redux","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/react/css","external/classnames","modules/core/i18n","modules/clean/auth/login_or_register/types","modules/clean/react_format","external/lodash","modules/constants/file_viewer","spectrum_comments/comment","spectrum_comments/comment_editor","spectrum_comments/comment_stream","spectrum_comments/coachmark_location","spectrum_comments/utils/guest_utils","modules/clean/react/comments2/actions_adapters/index","modules/clean/react/comments2/components/onboarding","modules/clean/react/comments2/components/coachmark","modules/clean/react/comments2/components/sidebar_listener","modules/clean/react/comments2/components/util","modules/clean/react/comments2/util","modules/clean/react/comments2/data/types","modules/clean/react/comments2/transforms","modules/clean/react/comments2/data/actions","modules/clean/react/file_viewer/data/selectors","modules/clean/react/comments2/data/selectors","modules/clean/react/comments2/data/perf_util","modules/clean/react/comments2/data/mentions_api","modules/clean/react/file_viewer/more_dropdown/more_option_registry","modules/clean/react/file_action_button","modules/clean/react/file_viewer/more_dropdown/models","modules/clean/previews/constants","modules/clean/react/comments2/components/comments_translations","modules/clean/react/comments2/components/tooltips","modules/clean/sharing/actions/sharing_actions"],function(e,t,o,n,i,r,a,s,l,m,c,d,p,u,h,_,g,f,b,v,w,E,y,T,C,O,S,A,M,I,P,k,D,U,x,N,R,F,V){"use strict";function B(e,t){return void 0===t&&(t=1),e===N.PreviewType.SsrDoc?{type:"document",regionType:"rectangle",regions:[{page:t,x:0,y:0,width:1,height:1}]}:{type:"image",region:{x:0,y:0,width:1,height:1}}}function L(e){var t=e.currentPageIndex,i=void 0===t?0:t,r=e.disabledTimeCodeTooltipComponent,a=e.playerCurrentTime,s=void 0===a?0:a,l=e.pendingNumberedAnnotation,m=e.playerIntegrationEnabled,c=e.previewType,d=e.upsellTooltipComponent;if(c===N.PreviewType.Audio||c===N.PreviewType.Video){var p=void 0;d?p=d:m||(p=r);var u=c===N.PreviewType.Audio?"audio":"video";return n.default.createElement(_.TimeCodedCommentEditor,o.__assign({},e,{pendingAnnotation:{type:u,time:s},tooltipComponent:p}))}return c===N.PreviewType.SsrDoc||c===N.PreviewType.Image?n.default.createElement(_.NumberedCommentEditor,o.__assign({},e,{defaultAnnotation:B(c,i+1),pendingAnnotation:l})):n.default.createElement(_.CommentEditor,o.__assign({},e))}Object.defineProperty(t,"__esModule",{value:!0}),n=o.__importDefault(n),i=o.__importStar(i),a=o.__importStar(a),l=o.__importDefault(l),p=o.__importStar(p),I=o.__importStar(I),P=o.__importStar(P);var G=["image_preview_surface","document_preview_surface","how_to_at_mention_comments_pane_surface"],K=function(e){var t=e.children,o=e.markOnboarded,i=e.playerIntegrationEnabled,r=e.previewType,a=e.showOnboarding,s=i?"target-annotation":"target-mention",l=r!==N.PreviewType.Image&&r!==N.PreviewType.SsrDoc;return n.default.createElement(_.CoachMarkContainer,{className:s},t,l&&a&&n.default.createElement(w.CoachMark,{markOnboarded:o,playerIntegrationEnabled:i,previewType:r}))},q=(function(t){function i(i){var s=t.call(this,i)||this;s.mentionsQueryId=0,s.onCommentStreamRef=function(e){return s.commentStream=e},s.updateMentionsMatches=function(e){s.setState({mentionsMatches:e})},s.logMentionsQueryCompletedPerf=function(e){var t=P.mentionsQueryCompleted();s.props.dispatch(A.Actions.logPerfEvent(t,e))},s.onMentionsQueryUpdated=function(e){if(e){var t=++s.mentionsQueryId;s.mentionsApi.query(e,s.updateMentionsMatches,P.withTiming(s.updateMentionsMatches,function(e){s.mentionsQueryId===t&&s.logMentionsQueryCompletedPerf(e)}))}else""===e&&s.updateMentionsMatches(s.mentionsApi.getMatchesWithStarterSuggestions());s.props.dispatch(A.Actions.markOnboardedIfUnmarked("how_to_at_mention_comments_pane_surface"))},s.onPostSuccess=function(e,t){e.metadata&&e.metadata.some(function(e){return"mention"===e.type})&&V.SharingActions.listMembers({user:t,contentId:s.props.stream.id,isFolder:!1,url:s.props.stream.linkUrl,includeSeenState:!1})},s.showEmailVerifyModal=function(e){if(!s.props.hasShownAnyModalVariant||e!==O.ShowModalReason.EditorFocus){s.props.dispatch(A.Actions.markModalVariantShown(O.ModalVariant.EmailVerifyModal)),s.props.dispatch(A.Actions.logEvent("email_verify_modal_shown"));var t=function(){s.props.dispatch(A.Actions.logEvent("email_verify_flow_completed"))};r.EmailVerification.get_for_user(s.props.viewer).show_verify_modal(t,a.ADD_COMMENT)}},s.showSignUpModal=function(t){if((!s.props.hasShownAnyModalVariant||t!==O.ShowModalReason.EditorFocus)&&u.SHARED_LINK_REACT_AUTH_MODAL){var i=function(){return o.__awaiter(s,void 0,void 0,function(){var t,i,r,a;return o.__generator(this,function(s){switch(s.label){case 0:return[4,Promise.all([new Promise(function(t,o){e(["modules/clean/react/modal"],t,o)}).then(o.__importStar),new Promise(function(t,o){e(["modules/clean/auth/login_or_register/modal"],t,o)}).then(o.__importStar),new Promise(function(t,o){e(["modules/core/browser"],t,o)}).then(o.__importStar)])];case 1:return t=s.sent(),i=t[0].Modal,r=t[1].LoginOrRegisterModal,a=t[2],i.showInstance(n.default.createElement(r,{commentParams:{fileActivityKey:"asdf",variant:c.CommentTextVariant.POST},downloadAction:null,id:"shared-link-default-comments-signup-modal",kind:c.LoginOrRegisterKind.COMMENT,onAuthenticateSuccess:function(){return a.reload()},onCancel:p.noop,signup_tag:"comments_shmodel_modal_register"})),[2]}})})};s.props.dispatch(A.Actions.markModalVariantShown(O.ModalVariant.SignUpModal)),i()}},s.toggleShowResolved=function(){var e=s.props,t=e.dispatch,o=e.showResolved,n=o?"hide_resolved_threads":"show_resolved_threads";t(A.Actions.toggleShowResolved()),t(A.Actions.logEvent(n))},s.setCommentsEnabled=function(){s.props.dispatch(A.Actions.enableCommenting())},s.setCommentsDisabled=function(){s.props.dispatch(A.Actions.disableCommenting())},s.dismissImagePreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("image_preview_surface")},s.dismissDocumentPreviewSurfaceOnboarding=function(){s.dismissOnboarding(),s.markOnboarded("document_preview_surface")},s.dismissHowToAtMentionOnoarding=function(){s.dismissOnboarding(),s.markOnboarded("how_to_at_mention_comments_pane_surface")},s.createComment=function(e){switch(s.props.previewType){case N.PreviewType.Video:case N.PreviewType.Audio:return n.default.createElement(h.TimeCodedComment,o.__assign({},e,{playerIntegrationEnabled:s.props.playerIntegrationEnabled}));case N.PreviewType.Image:case N.PreviewType.SsrDoc:return n.default.createElement(h.NumberedComment,o.__assign({},e));default:return n.default.createElement(h.Comment,o.__assign({},e))}},s.createEditor=function(e){var t=s.props,i=t.currentPageIndex,r=t.pendingNumberedAnnotation,a=t.playerCurrentTime,l=t.playerIntegrationEnabled,m=t.previewType,c=t.showOnboarding,d=t.upsellTooltipVariant,p=d?s.createUpsellTooltip:void 0;return n.default.createElement(K,{markOnboarded:s.markOnboarded,playerIntegrationEnabled:l,previewType:m,showOnboarding:c},n.default.createElement(L,o.__assign({},e,{disabledTimeCodeTooltipComponent:s.createDisabledTimeCodeTooltip,upsellTooltipComponent:p,pendingNumberedAnnotation:r,currentPageIndex:i,playerIntegrationEnabled:l,playerCurrentTime:a,previewType:m})))},s.createDisabledTimeCodeTooltip=function(e){return n.default.createElement(F.DisabledTimeCodeTooltip,o.__assign({},e,{onClick:s.onDisabledTooltipLearnMoreClick,onShow:s.onDisabledTooltipShow}))},s.createUpsellTooltip=function(e){return n.default.createElement(F.UpsellTooltip,o.__assign({},e,{onClick:s.onUpsellTooltipClick,onDismiss:s.onUpsellTooltipDismiss,onShow:s.onUpsellTooltipShow,variant:s.props.upsellTooltipVariant,showUpsellExperiment:!s.props.collapsed&&s.props.showUpsellExperiment}))},s.onDisabledTooltipLearnMoreClick=function(){return s.props.dispatch(A.Actions.logEvent("time_based_tooltip_learn_more_click"))},s.onDisabledTooltipShow=function(){return s.props.dispatch(A.Actions.logEvent("time_based_tooltip_learn_more_view"))},s.onUpsellTooltipClick=function(){s.dismissUpsell(),s.props.dispatch(A.Actions.logEvent("time_based_tooltip_upgrade_click"))},s.onUpsellTooltipDismiss=function(){s.dismissUpsell(),s.props.dispatch(A.Actions.logEvent("time_based_tooltip_upgrade_dismiss"))},s.onUpsellTooltipShow=function(){return s.props.dispatch(A.Actions.logEvent("time_based_tooltip_upgrade_view"))},s.markOnboarded=function(e){s.props.dispatch(A.Actions.markOnboarded(e))},s.dismissOnboarding=function(){s.props.dispatch(A.Actions.dismissOnboarding(null))};var l=i.viewer;return s.mentionsApi=k.mentionsApi(l),s.state={mentionsMatches:s.mentionsApi.cache},s}return o.__extends(i,t),i.prototype.buildResolveOption=function(){var e=this.props.showResolved?U.FileActionButtonType.HIDE_RESOLVED_COMMENTS:U.FileActionButtonType.SHOW_RESOLVED_COMMENTS;return new x.MoreOption({className:"comments-options-item__show-resolved",fileActionButtonType:e,component:function(e){return n.default.createElement("span",null,e.buttonText)},handler:this.toggleShowResolved})},i.prototype.buildEnableOption=function(){var e,t;return this.props.isEnabled?(e=U.FileActionButtonType.DISABLE_COMMENTS,t=this.setCommentsDisabled):(e=U.FileActionButtonType.ENABLE_COMMENTS,t=this.setCommentsEnabled),new x.MoreOption({className:"comments-options-item__disable",fileActionButtonType:e,component:function(e){return n.default.createElement("span",null,e.buttonText)},handler:t})},i.prototype.buildSubscribeOption=function(){var e,t,o=this;return this.props.isSubscribed?(e=U.FileActionButtonType.UNSUBSCRIBE,t=function(){return o.props.dispatch(A.Actions.unsubscribe(void 0))}):(e=U.FileActionButtonType.SUBSCRIBE,t=function(){return o.props.dispatch(A.Actions.subscribe(void 0))}),new x.MoreOption({className:"comments-options-item__subscribe",fileActionButtonType:e,component:function(e){return n.default.createElement("span",null,e.buttonText)},handler:t})},i.prototype.updateCommentsMoreOptionGroup=function(){var e=[];this.props.canEnable&&e.push(this.buildEnableOption()),e.push(this.buildResolveOption()),this.props.canSubscribe&&e.push(this.buildSubscribeOption());var t=new x.MoreOptionGroup({fileActionButtonGroup:U.FileActionButtonGroup.COMMENTS,options:e});void 0===this.moreOptionGroup?D.moreOptionRegistry.addOption(t):D.moreOptionRegistry.replaceOption(this.moreOptionGroup,t),this.moreOptionGroup=t},i.prototype.componentDidMount=function(){this.updateCommentsMoreOptionGroup();var e=this.props,t=e.dispatch,o=e.showOnboarding,n=e.perfEvents,i=+new Date;t(A.Actions.logEvent("show_comments")),t(A.Actions.logSimplePerfEvent("stream_displayed_ms",i-(n.listCompleteTime||0))),t(A.Actions.logSimplePerfEvent("comment_editor_tti_ms",i-(n.setContextTime||0))),o&&t(A.Actions.logEvent("sidebar_onboarding_shown"))},i.prototype.componentDidUpdate=function(e){var t=e.requestEditorFocus,o=e.showOnboarding,n=this.props,i=n.showOnboarding,r=n.dispatch,a=n.requestEditorFocus;this.updateCommentsMoreOptionGroup(),!o&&i&&r(A.Actions.logEvent("sidebar_onboarding_shown")),!t&&a&&(this.commentStream.focusPrimaryEditor(),r(A.Actions.fulfillEditorFocusRequest()))},i.prototype.componentWillUnmount=function(){this.moreOptionGroup&&D.moreOptionRegistry.removeOption(this.moreOptionGroup)},Object.defineProperty(i.prototype,"onboardingKeysToMarkOnThreadCreation",{get:function(){return p.difference(this.props.relevantOnboardingKeys,G)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"imagePdfCoachmarkData",{get:function(){var e=this,t=this.props,i=t.showOnboarding,r=t.relevantOnboardingKeys,a=m._("Animation of annotating a file",{comment:"This is alt text for an animated gif"}),s=i&&p.head(p.intersection(G,r)),l={title:n.default.createElement("h2",{className:"sc-coachmark-title"}),body:n.default.createElement("p",null)};switch(s){case"document_preview_surface":return{location:f.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return n.default.createElement(E.CommentsCoachmark,o.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissDocumentPreviewSurfaceOnboarding}),n.default.createElement(T.Comments2OnboardingImage,{fileNamePrefix:"02_Comments2_PDFComments","aria-label":a}),d.reactFormat(m._("<title>Call it out</title> <body>Select an area on the file to highlight and comment.</body>"),l))}};case"image_preview_surface":return{location:f.CoachmarkLocations.BELOW_COMMENT_STREAM,component:function(t){return n.default.createElement(E.CommentsCoachmark,o.__assign({},t,{overrideArrowPlacement:"left",onClose:e.dismissImagePreviewSurfaceOnboarding}),n.default.createElement(T.Comments2OnboardingImage,{fileNamePrefix:"01_Comments2_ImageComment","aria-label":a}),d.reactFormat(m._("<title>Call it out</title> <body>Select an area on the image to highlight and comment.</body>"),l))}};case"how_to_at_mention_comments_pane_surface":return{location:f.CoachmarkLocations.ABOVE_COMMENT_STREAM,target:f.CoachmarkTargets.MAIN_EDITOR_MENTION_BUTTON,component:function(t){return n.default.createElement(E.CommentsCoachmark,o.__assign({},t,{onClose:e.dismissHowToAtMentionOnoarding}),n.default.createElement(T.Comments2OnboardingImage,{fileNamePrefix:"03_Comments_AtMentions_v1","aria-label":m._("Animation of mentioning a user",{comment:"This is alt text for an animated gif"})}),d.reactFormat(m._("<title>Get the feedback you need</title> <body>Tag someone to work together on this file.</body>"),l))}};default:return}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"actionsAdapter",{get:function(){var e=this.props.fileSidebarDispatch;return v.createActionsAdapter(this.props,e,this.onboardingKeysToMarkOnThreadCreation,this.onMentionsQueryUpdated,this.onPostSuccess,this.showSignUpModal,this.showEmailVerifyModal)},enumerable:!0,configurable:!0}),i.prototype.dismissUpsell=function(){var e=C.inUpsellExperiment();this.props.showUpsellExperiment?this.props.dispatch(A.Actions.dismissUpsellExperiment(void 0)):e||this.props.dispatch(A.Actions.dismissUpsellTooltip(void 0))},i.prototype.render=function(){var e,t=this.props,o=t.activeThreadId,i=t.collapsed,r=t.dispatch,a=t.editorIsEmpty,s=t.hoverThreadId,m=t.isMobile,c=t.showResolved,d=t.stream.id,p=t.viewer,u=t.previewType,h=t.streamSettings,_=this.props.threads.filter(function(e){return c||!e.resolved});e=p?S.dbxUserToIUser(p):b.getGuestIUser();var f=u===N.PreviewType.Image||u===N.PreviewType.SsrDoc;return n.default.createElement("div",{className:l.default("comments-pane-wrapper",{"no-comment":C.isComments2Mobile()&&0===_.length})},n.default.createElement(g.CommentStream,{ref:this.onCommentStreamRef,id:d,actionsAdapter:this.actionsAdapter,commentComponent:this.createComment,editorComponent:this.createEditor,enabled:!0,isMobile:!!m,mentionsMatches:this.state.mentionsMatches,settings:h,threads:_,user:e,activeThreadID:o,hoverThreadID:s,showUnreadPill:C.canShowUnreadPill(),localization:R.commentsMasterLocalization,collapsed:i,coachmarkData:this.imagePdfCoachmarkData,showRevisionInfo:f}),n.default.createElement(y.SidebarListener,{dispatch:r,editorIsEmpty:a}))},i})(n.default.Component);t.CommentsPaneComponent=q;var H=i.connect(function(e){var t=I.getContext(e),o=t.stream,n=t.viewer,i=I.getData(e),r=i.perfEvents,a=i.upsellExperimentNotDismissed,s=i.upsellTooltipVariant;return{activeThreadId:I.getActivatedThreadId(e),annotationsMode:I.getComments2AnnotationsMode(e),editorIsEmpty:I.getEditorIsEmpty(e),hasShownAnyModalVariant:I.getHasShownAnyModalVariant(e),hoverThreadId:I.getHoverThreadId(e),playerCurrentTime:I.getPlayerCurrentTime(e),playerIntegrationEnabled:I.getIsPlayerIntegrationEnabled(e),relevantOnboardingKeys:I.getUnmarkedOnboardingKeysRelevantToCurrentFile(e),showOnboarding:I.getShowOnboardingOnCommentsPane(e),showResolved:I.getShowResolved(e),canEnable:I.getCanEnable(e),isEnabled:I.getIsEnabled(e),canSubscribe:I.getCanSubscribe(e),isSubscribed:I.getIsSubscribed(e),pendingNumberedAnnotation:I.getPendingNumberedAnnotation(e),previewType:I.getPreviewTypeForCurrentFile(e),currentPageIndex:M.getCurrentPageIndex(e),showUpsellExperiment:C.inUpsellExperiment()&&a,stream:o,threads:I.getThreads(e),viewer:n,upsellTooltipVariant:s,perfEvents:r,requestEditorFocus:I.getIsEditorFocusRequested(e),streamSettings:I.getStreamSettings(e)}})(q);t.CommentsPane=s.requireCssWithComponent(H,["/static/js/spectrum_comments/index.web-vflYQwrNg.css","/static/css/comments2-sidebar-vfl9MyDoE.css","/static/css/comments_annotations-vflhvjxUZ.css","/static/css/snackbar-vflLtw9Um.css"])});
//# sourceMappingURL=comments_pane.min.js-vflX0lGlm.map